#include <stdio.h>
#include <stdlib.h>
#include <string.h>

// --- Definitions & Structures ---
#define ADMIN_USER "admin"
#define ADMIN_PASS "1234"

typedef struct {
    int id;
    char name[50];
    float gpa;
} Student;

const char* FILENAME = "students.dat";

// --- Function Prototypes ---
int login();
void addStudent();
void displayStudents();
void searchStudent();
void updateStudent();
void deleteStudent();

// --- Main Gatekeeper ---
int main() {
    if (!login()) {
        printf("\nToo many failed attempts. System Locked.\n");
        return 0;
    }

    int choice;
    while (1) {
        printf("\n==============================");
        printf("\n   STUDENT DATABASE (ADMIN)");
        printf("\n==============================");
        printf("\n1. Add Record\n2. View All\n3. Search by ID\n4. Update Record\n5. Delete Record\n6. Logout & Exit");
        printf("\nSelection: ");
        
        if (scanf("%d", &choice) != 1) break; // Safety if non-numeric input is entered

        switch (choice) {
            case 1: addStudent(); break;
            case 2: displayStudents(); break;
            case 3: searchStudent(); break;
            case 4: updateStudent(); break;
            case 5: deleteStudent(); break;
            case 6: printf("Logging out...\n"); exit(0);
            default: printf("Invalid option!\n");
        }
    }
    return 0;
}

// --- Logic Implementations ---

int login() {
    char user[20], pass[20];
    int attempts = 3;

    while (attempts > 0) {
        printf("\n--- Login Required ---\nUsername: ");
        scanf("%s", user);
        printf("Password: ");
        scanf("%s", pass);

        if (strcmp(user, ADMIN_USER) == 0 && strcmp(pass, ADMIN_PASS) == 0) {
            return 1; // Success
        } else {
            attempts--;
            printf("Access Denied. %d attempts remaining.\n", attempts);
        }
    }
    return 0; // Fail
}

void addStudent() {
    FILE *fp = fopen(FILENAME, "ab");
    if (!fp) return;
    Student s;
    printf("Enter ID: "); scanf("%d", &s.id);
    printf("Enter Name: "); scanf("%s", s.name);
    printf("Enter GPA: "); scanf("%f", &s.gpa);
    
    fwrite(&s, sizeof(Student), 1, fp);
    fclose(fp);
    printf("Student added successfully.\n");
}

void displayStudents() {
    FILE *fp = fopen(FILENAME, "rb");
    Student s;
    if (!fp) { printf("No database file found.\n"); return; }
    
    printf("\n%-10s %-20s %-5s", "ID", "Name", "GPA");
    printf("\n--------------------------------------\n");
    while (fread(&s, sizeof(Student), 1, fp)) {
        printf("%-10d %-20s %-5.2f\n", s.id, s.name, s.gpa);
    }
    fclose(fp);
}

void searchStudent() {
    FILE *fp = fopen(FILENAME, "rb");
    int id, found = 0;
    Student s;
    if (!fp) return;

    printf("Search ID: ");
    scanf("%d", &id);

    while (fread(&s, sizeof(Student), 1, fp)) {
        if (s.id == id) {
            printf("\nMatch Found: %s | GPA: %.2f\n", s.name, s.gpa);
            found = 1;
            break;
        }
    }
    if (!found) printf("No student found with ID %d.\n", id);
    fclose(fp);
}

void updateStudent() {
    FILE *fp = fopen(FILENAME, "rb+");
    int id, found = 0;
    Student s;
    if (!fp) return;

    printf("Update ID: ");
    scanf("%d", &id);

    while (fread(&s, sizeof(Student), 1, fp)) {
        if (s.id == id) {
            printf("Current: %s, GPA: %.2f. Enter new Name & GPA: ", s.name, s.gpa);
            scanf("%s %f", s.name, &s.gpa);
            fseek(fp, -sizeof(Student), SEEK_CUR); 
            fwrite(&s, sizeof(Student), 1, fp);
            found = 1;
            break;
        }
    }
    fclose(fp);
    if (found) printf("Record updated.\n");
    else printf("ID not found.\n");
}

void deleteStudent() {
    FILE *fp = fopen(FILENAME, "rb");
    FILE *temp = fopen("temp.dat", "wb");
    int id, found = 0;
    Student s;
    if (!fp || !temp) return;

    printf("Delete ID: ");
    scanf("%d", &id);

    while (fread(&s, sizeof(Student), 1, fp)) {
        if (s.id == id) found = 1;
        else fwrite(&s, sizeof(Student), 1, temp);
    }
    fclose(fp);
    fclose(temp);
    remove(FILENAME);
    rename("temp.dat", FILENAME);
    if (found) printf("Record removed.\n");
    else printf("Record not found.\n");
}

